!function(a,b){if("function"==typeof define&&define.amd)define(["underscore","backbone","backbone.marionette"],function(c,d,e){return b(a,c,d,e)});else if("undefined"!=typeof exports){var c=require("backbone"),d=require("underscore"),e=require("backbone.marionette");module.exports=b(a,d,c,e)}else a.Marionette.GridView=b(a,a._,a.Backbone,a.Marionette)}(this,function(a,b,c,d){"use strict";var e={},f="WidgetView",g="No Name",h=0,i=0,j=1,k=1;e.Widget=c.Model.extend({defaults:{viewType:f,name:g,x:h,y:i,width:j,height:k,widgetId:0},getGridstackAttributes:function(){return{id:this.get("widgetId"),x:this.get("x"),y:this.get("y"),width:this.get("width"),height:this.get("height"),el:'<div class="grid-stack-item"><div id="'+this.getRegionName()+'" class="grid-stack-item-content"></div></div>'}},isDefaultView:function(){return this.get("viewType")===this.getDefaultView()},getDefaultView:function(){return f},getRegionName:function(){return this.get("viewType")+this.get("widgetId")}}),e.WidgetList=c.Collection.extend({model:e.Widget});var l='<div class="default-widget"><p>default view</p></div>';e.WidgetView=d.ItemView.extend({template:b.template(l),modelEvents:{change:"render"},onRender:function(){this.$el=this.$el.children(),this.$el.unwrap(),this.setElement(this.$el),this.trigger("after:render")}});var m='<div id="main-gridstack" class="grid-stack">  </div>';return e.WidgetGridView=d.LayoutView.extend({template:b.template(m),collectionEvents:{add:"onCollectionAdd",remove:"onCollectionRemove",reset:"onCollectionReset",change:"onModelChange"},initialize:function(a){if(a=a||{},a.gsOptions=a.gsOptions||{},a.logHelper=a.logHelper||{},b.isUndefined(a.autoPos)&&(a.autoPos=!0),!a.collection)throw new Error("Missing collection inside initialization options");this.settings=a,this.rendered=!1},setAutoPos:function(a){this.settings.autoPos=a},setGridstackOptions:function(a){this.settings.gsOptions=a},onCollectionAdd:function(a){this.saveCollection(),this.addWidgetView(a)},onCollectionRemove:function(a){this.saveCollection(),this.removeWidgetView(a)},onCollectionReset:function(){this.saveCollection(),this.resetGridView()},onModelChange:function(){this.saveCollection()},saveCollection:function(){if(!b.isEmpty(this.settings.autoSave)){var a=this.settings.autoSave.options||{};b.isFunction(a)&&(a=a()),this.settings.autoSave.callback(this.collection,a)}},onRender:function(){this.rendered=!0,this.initializeGridstack(),this.populateWidgetViews()},initializeGridstack:function(){this.$(".grid-stack").gridstack(this.settings.gsOptions),this.gridstack=this.$(".grid-stack").data("gridstack"),this.$(".grid-stack").on("change",b.bind(this.updateAllWidgetsAttributes,this))},populateWidgetViews:function(){this.collection.each(function(a){this.addWidgetView(a)},this)},addWidgetView:function(a){if(this.rendered){var b=a.getGridstackAttributes();this.gridstack.will_it_fit(b.x,b.y,b.width,b.height,this.settings.autoPos)?(this.gridstack.add_widget(b.el,b.x,b.y,b.width,b.height,this.settings.autoPos),this.settings.autoPos&&this.updateWidgetAttributes(a.getRegionName(),b.id),this.addRegion(a.getRegionName(),"#"+a.getRegionName()),this.showWidgetView(a)):(this.collection.remove(a,{silent:!0}),this.saveCollection(),this.helpMessage("NOT_ENOUGH_SPACE"))}else this.helpMessage("GRID_NOT_RENDERED_BEFORE_ADD")},removeWidgetView:function(a){if(this.rendered){var b=a.getRegionName(),c=this.$("#"+b).closest(".grid-stack-item");this.removeRegion(b),this.gridstack.remove_widget(c),this.updateAllWidgetsAttributes()}else this.helpMessage("GRID_NOT_RENDERED_BEFORE_REMOVE")},resetGridView:function(){this.rendered?(this.gridstack.remove_all(),this.initializeGridstack(),this.populateWidgetViews()):this.helpMessage("GRID_NOT_RENDERED_BEFORE_RESET")},showWidgetView:function(a){var b=this.getViewToShow(a);this.listenTo(b,"remove:widget",this.removeWidget),this.getRegion(a.getRegionName()).show(b)},getViewToShow:function(a){return this.settings.customViews&&this.settings.customViews[a.get("viewType")]?new(this.settings.customViews[a.get("viewType")])({model:a}):(a.isDefaultView()||a.set("viewType",a.getDefaultView()),new e.WidgetView({model:a}))},removeWidget:function(a){this.collection.remove(a.model)},helpMessage:function(a){var b=this.settings.logHelper.callback||window.alert,c=this.settings.logHelper.messages||this.getDefaultMessages(),d=this.settings.logHelper.context;b.call(d,c[a])},updateAllWidgetsAttributes:function(){this.collection.each(function(a){this.updateWidgetAttributes(a.getRegionName(),a.get("widgetId"))},this)},updateWidgetAttributes:function(a,b){var c=this.$("#"+a).closest(".grid-stack-item");this.collection.findWhere({widgetId:b}).set({x:parseInt(c.attr("data-gs-x"),10),y:parseInt(c.attr("data-gs-y"),10),width:parseInt(c.attr("data-gs-width"),10),height:parseInt(c.attr("data-gs-height"),10)})},getDefaultMessages:function(){return{NOT_ENOUGH_SPACE:"Not enough free space to add that last widget",GRID_NOT_RENDERED_BEFORE_ADD:"The grid view needs to be rendered before trying to add widgets to the view",GRID_NOT_RENDERED_BEFORE_REMOVE:"The grid view needs to be rendered before trying to remove widgets from the view",GRID_NOT_RENDERED_BEFORE_RESET:"The grid view needs to be rendered before trying to reset the view"}}}),e});